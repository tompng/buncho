<script src='src/shape.js'></script>
<script src='src/buncho.js'></script>
<script src='src/key.js'></script>
<script src='src/stage.js'></script>
<script src='src/enemy.js'></script>
<script>
const canvas = document.createElement('canvas')
onload = () => {
  const keymap = new KeyMap()
  const img = new Image()
  img.src = 'gameover.png'
  keymap.attach(document)
  document.body.appendChild(canvas)
  canvas.width = canvas.height = 1024
  const ctx = canvas.getContext('2d')
  canvas.style.width = 512
  canvas.style.boxShadow='0 0 1px black'
  let b, stage, gameover
  let started = false
  function initialize() {
    gameover = null
    enemies = [new Enemy(), new Enemy()]
    b = new Buncho()
    stage = new Stage()
  }
  const icon = new Buncho()
  initialize()
  setInterval(()=>{
    ctx.save()
    ctx.clearRect(0, 0, 1024, 1024)
    ctx.translate(512, 800)
    ctx.scale(64, -64)
    const hrange = b.hitRange()
    if (gameover) {
      gameover.count++
      if (gameover.count > 100) {
        gameover = null
        started = false
        initialize()
      }
    }
    if (!gameover) {
      if (keymap.current.LEFT || keymap.current.RIGHT || keymap.current.UP || keymap.current.DOWN) {
        started = true
      }
      b.update(keymap, stage)
      if (started) enemies.forEach(e => e.update(b))
    }
    enemies.forEach(e => {
      if (!gameover && e.test(hrange)) gameover = {
        count: 0
      }
    })
    keymap.clear()
    stage.render(ctx)
    enemies.forEach(e => e.render(ctx))
    b.render(ctx)
    if (gameover) {
      ctx.save()
      ctx.translate(b.position.x + 1.2, b.position.y + 0.4)
      ctx.lineWidth = 0.2
      ctx.strokeStyle = 'gray'
      ctx.fillStyle = 'red'
      ctx.beginPath()
      ctx.rect(-0.15, -0.15, 0.3, 0.3)
      ctx.rect(-0.15, 0.4, 0.3, 0.8)
      ctx.stroke()
      ctx.fill()
      ctx.restore()
    }
    ctx.restore()
    if (gameover && gameover.count > 10) {
      ctx.save()
      ctx.globalAlpha = Math.min((gameover.count - 10) / 40, 1)
      ctx.drawImage(img, 0, 0, 1024, 1024)
      ctx.globalAlpha = Math.max(0, Math.min((gameover.count - 50) / 40, 1))
      ctx.fillStyle = 'white'
      ctx.fillRect(0, 0, 1024, 1024)
      ctx.restore()
    }
  }, 20)
}
</script>
